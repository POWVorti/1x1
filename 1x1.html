<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einmaleins-Trainer</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a nice, readable font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight on mobile */
        }
        .app-container {
            max-width: 480px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .btn {
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        .btn:active {
            transform: scale(0.96);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);
        }
    
:root {
    --app-height: 100vh;
}

.app-container {
    max-width: 480px;
    height: var(--app-height);
    display: flex;
    flex-direction: column;
}

/* Landscape: größere Höhe und zentrierter Inhalt */
@media screen and (orientation: landscape) {
    .app-container {
        max-width: none;
        width: 100%;
        justify-content: center;
        align-items: center;
        padding: 1rem;
    }

    #start-screen,
    #training-screen,
    #results-screen {
        flex: 1;
        overflow: auto;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        max-width: 600px;
        margin: auto;
    }
}

</style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center">

    <div id="app" class="app-container w-full bg-white dark:bg-gray-800 shadow-lg rounded-lg overflow-hidden">

        <!-- Start Screen -->
        <div id="start-screen" class="p-6 md:p-8 flex flex-col justify-center items-center h-full">
            <h1 class="text-3xl md:text-4xl font-bold text-center mb-4">Einmaleins-Trainer</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400 text-center mb-8">Bitte wähle den Modus:</p>
            <div class="w-full max-w-sm space-y-4">
                <button onclick="app.startGame('random')" class="btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-4 rounded-lg shadow-md">
                    1. Zufällige Aufgaben
                </button>
                <button onclick="app.startGame('rows')" class="btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-4 rounded-lg shadow-md">
                    2. Reihenweise Aufgaben
                </button>
            </div>
        </div>

        <!-- Training Screen -->
        <div id="training-screen" class="hidden p-4 md:p-6 flex flex-col h-full">
            <!-- Header with stats -->
            <div class="flex justify-between items-center text-lg mb-4">
                <div id="error-counter" class="font-semibold">Fehler: 0</div>
                <div id="timer" class="font-bold">Zeit: 0:00</div>
                <div id="task-counter" class="font-semibold">Übrig: 100</div>
            </div>

            <!-- Task display -->
            <div class="flex-grow flex flex-col items-center justify-center">
                <div id="task-question" class="text-5xl md:text-6xl font-bold text-center mb-4">1 × 1 = ?</div>
                <div id="answer-display" class="h-16 w-full max-w-xs bg-gray-200 dark:bg-gray-700 rounded-lg text-4xl font-mono text-center flex items-center justify-center mb-4">&nbsp;</div>
                <div id="feedback-message" class="h-8 text-xl text-center font-semibold">&nbsp;</div>
            </div>

            <!-- Number Pad -->
            <div id="numpad" class="grid grid-cols-3 gap-3 md:gap-4 w-full max-w-sm mx-auto">
                <!-- Numpad buttons will be generated by JavaScript -->
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="hidden p-6 md:p-8 flex flex-col justify-center items-center h-full text-center">
            <h1 class="text-4xl font-bold mb-4">Fertig!</h1>
            <div class="text-xl mb-6">
                <p id="final-time">Zeit: 0:00</p>
                <p id="final-errors">Fehler: 0</p>
            </div>
            <div id="final-stars" class="text-5xl mb-4">⭐⭐⭐⭐⭐</div>
            <p id="final-message" class="text-xl font-semibold mb-8">Top! Sehr sicher und schnell</p>
            <button onclick="app.showStartScreen()" class="btn w-full max-w-sm bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-4 rounded-lg shadow-md">
                Nochmal
            </button>
        </div>
    </div>

    <script>
        // Main application logic
        const app = {
            // --- STATE ---
            mode: 'random',
            startTime: null,
            endTime: null,
            timerInterval: null,
            errorCount: 0,
            currentTask: null,
            correctAnswer: 0,
            userAnswer: '',
            allTasks: [],
            errorTasks: [],
            rowOrder: [],
            currentRowIndex: 0,
            tasksForRow: [],

            // --- UI ELEMENTS ---
            ui: {
                startScreen: document.getElementById('start-screen'),
                trainingScreen: document.getElementById('training-screen'),
                resultsScreen: document.getElementById('results-screen'),
                errorCounter: document.getElementById('error-counter'),
                timer: document.getElementById('timer'),
                taskCounter: document.getElementById('task-counter'),
                taskQuestion: document.getElementById('task-question'),
                answerDisplay: document.getElementById('answer-display'),
                feedbackMessage: document.getElementById('feedback-message'),
                numpad: document.getElementById('numpad'),
                finalTime: document.getElementById('final-time'),
                finalErrors: document.getElementById('final-errors'),
                finalStars: document.getElementById('final-stars'),
                finalMessage: document.getElementById('final-message'),
            },

            // --- SOUND ---
            audioContext: null,
            playSound(type) {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                const context = this.audioContext;
                const oscillator = context.createOscillator();
                const gainNode = context.createGain();

                if (type === 'success') {
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(880, context.currentTime); // A5 note
                    gainNode.gain.setValueAtTime(0.3, context.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.0001, context.currentTime + 0.2);
                } else { // 'fail'
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(220, context.currentTime); // A3 note
                    gainNode.gain.setValueAtTime(0.2, context.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.0001, context.currentTime + 0.3);
                }

                oscillator.connect(gainNode);
                gainNode.connect(context.destination);
                oscillator.start();
                oscillator.stop(context.currentTime + 0.3);
            },

            // --- INITIALIZATION ---
            init() {
                this.buildNumpad();
            },

            buildNumpad() {
                const buttons = [
                    '1', '2', '3',
                    '4', '5', '6',
                    '7', '8', '9',
                    'DEL', '0', 'OK'
                ];
                buttons.forEach(label => {
                    const button = document.createElement('button');
                    button.textContent = label;
                    button.className = 'btn text-2xl font-semibold rounded-lg shadow-md h-16 md:h-20';
                    
                    if (label === 'OK') {
                        button.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white');
                    } else if (label === 'DEL') {
                        button.classList.add('bg-orange-500', 'hover:bg-orange-600', 'text-white');
                    } else {
                        button.classList.add('bg-gray-200', 'hover:bg-gray-300', 'dark:bg-gray-700', 'dark:hover:bg-gray-600');
                    }
                    
                    button.onclick = () => this.handleNumpad(label);
                    this.ui.numpad.appendChild(button);
                });
            },

            // --- GAME FLOW ---
            startGame(mode) {
                this.mode = mode;
                this.resetState();

                this.ui.startScreen.classList.add('hidden');
                this.ui.resultsScreen.classList.add('hidden');
                this.ui.trainingScreen.classList.remove('hidden');

                this.generateTaskList();
                this.nextTask();
                this.startTimer();
            },

            resetState() {
                this.startTime = null;
                this.endTime = null;
                if(this.timerInterval) clearInterval(this.timerInterval);
                this.timerInterval = null;
                this.errorCount = 0;
                this.userAnswer = '';
                this.allTasks = [];
                this.errorTasks = [];
                this.rowOrder = [];
                this.currentRowIndex = 0;
                this.tasksForRow = [];
                this.updateAnswerDisplay();
                this.ui.feedbackMessage.textContent = '';
            },

            generateTaskList() {
                if (this.mode === 'random') {
                    this.allTasks = [];
                    for (let a = 1; a <= 10; a++) {
                        for (let b = 1; b <= 10; b++) {
                            this.allTasks.push({ a, b });
                        }
                    }
                    this.allTasks = this.shuffle(this.allTasks);
                } else { // 'rows'
                    this.rowOrder = this.shuffle([...Array(10).keys()].map(i => i + 1));
                    this.currentRowIndex = 0;
                    this.generateTasksForRow();
                }
            },

            generateTasksForRow() {
                if (this.currentRowIndex >= this.rowOrder.length) return;
                const currentRow = this.rowOrder[this.currentRowIndex];
                const leftOperands = this.shuffle([...Array(10).keys()].map(i => i + 1));
                this.tasksForRow = leftOperands.map(a => ({ a, b: currentRow }));
            },

            nextTask() {
                if (this.startTime === null) this.startTime = new Date();

                let taskFound = false;
                if (this.mode === 'random') {
                    if (this.allTasks.length > 0) {
                        this.currentTask = this.allTasks.shift();
                        taskFound = true;
                    } else if (this.errorTasks.length > 0) {
                        this.allTasks = this.shuffle(this.errorTasks);
                        this.errorTasks = [];
                        this.currentTask = this.allTasks.shift();
                        taskFound = true;
                    }
                } else { // 'rows'
                    if (this.tasksForRow.length > 0) {
                        this.currentTask = this.tasksForRow.shift();
                        taskFound = true;
                    } else if (this.errorTasks.length > 0) {
                        this.tasksForRow = this.shuffle(this.errorTasks);
                        this.errorTasks = [];
                        this.currentTask = this.tasksForRow.shift();
                        taskFound = true;
                    } else {
                        this.currentRowIndex++;
                        if (this.currentRowIndex < this.rowOrder.length) {
                            this.generateTasksForRow();
                            this.currentTask = this.tasksForRow.shift();
                            taskFound = true;
                        }
                    }
                }

                if (taskFound) {
                    this.correctAnswer = this.currentTask.a * this.currentTask.b;
                    this.ui.taskQuestion.textContent = `${this.currentTask.a} × ${this.currentTask.b} = ?`;
                    this.userAnswer = '';
                    this.updateAnswerDisplay();
                    this.ui.feedbackMessage.textContent = '';
                    this.updateStatus();
                } else {
                    this.finishGame();
                }
            },

            finishGame() {
                this.endTime = new Date();
                clearInterval(this.timerInterval);
                this.displayResults();
            },

            displayResults() {
                const totalTime = Math.round((this.endTime - this.startTime) / 1000);
                const minutes = Math.floor(totalTime / 60);
                const seconds = totalTime % 60;

                this.ui.finalTime.textContent = `Zeit: ${minutes}:${String(seconds).padStart(2, '0')}`;
                this.ui.finalErrors.textContent = `Fehler: ${this.errorCount}`;

                const [stars, message] = this.getEvaluation(this.errorCount, totalTime);
                this.ui.finalStars.textContent = stars;
                this.ui.finalMessage.textContent = message;

                this.ui.trainingScreen.classList.add('hidden');
                this.ui.resultsScreen.classList.remove('hidden');
            },
            
            getEvaluation(fehler, zeit) {
                if (fehler <= 2 && zeit <= 750) return ["⭐⭐⭐⭐⭐", "Top! Sehr sicher und schnell"];
                if (fehler <= 5 && zeit <= 810) return ["⭐⭐⭐⭐", "Sehr gut"];
                if (fehler <= 10 && zeit <= 900) return ["⭐⭐⭐", "Gut, aber kleine Unsicherheiten"];
                if (fehler <= 20 && zeit <= 1020) return ["⭐⭐", "Solide, mehr Übung nötig"];
                if (fehler <= 30 && zeit <= 1140) return ["⭐", "Viele Fehler, mehr Übung nötig"];
                return ["❌ 0 Sterne", "Ziel noch nicht erreicht"];
            },

            showStartScreen() {
                this.ui.resultsScreen.classList.add('hidden');
                this.ui.startScreen.classList.remove('hidden');
            },

            // --- INTERACTION ---
            handleNumpad(label) {
                if (label === 'OK') {
                    this.checkAnswer();
                } else if (label === 'DEL') {
                    if (this.userAnswer.length > 0) {
                        this.userAnswer = this.userAnswer.slice(0, -1);
                        this.updateAnswerDisplay();
                    }
                } else {
                    if (this.userAnswer.length < 5) {
                        this.userAnswer += label;
                        this.updateAnswerDisplay();
                    }
                }
            },

            checkAnswer() {
                if (this.userAnswer === '') return;

                if (parseInt(this.userAnswer) === this.correctAnswer) {
                    this.playSound('success');
                    this.ui.feedbackMessage.textContent = 'Richtig!';
                    this.ui.feedbackMessage.className = 'h-8 text-xl text-center font-semibold text-green-500';
                    setTimeout(() => this.nextTask(), 2000);
                } else {
                    this.playSound('fail');
                    this.errorCount++;
                    if (!this.errorTasks.find(t => t.a === this.currentTask.a && t.b === this.currentTask.b)) {
                        this.errorTasks.push(this.currentTask);
                    }
                    this.ui.feedbackMessage.textContent = 'Leider falsch!';
                    this.ui.feedbackMessage.className = 'h-8 text-xl text-center font-semibold text-red-500';
                    this.userAnswer = '';
                    this.updateAnswerDisplay();
                    this.updateStatus();
                }
            },

            // --- UI UPDATES ---
            updateAnswerDisplay() {
                this.ui.answerDisplay.textContent = this.userAnswer || ' ';
            },

            updateStatus() {
                this.ui.errorCounter.textContent = `Fehler: ${this.errorCount}`;
                let remaining = 0;
                if(this.mode === 'random') {
                    remaining = this.allTasks.length + this.errorTasks.length;
                } else {
                    remaining = this.tasksForRow.length + this.errorTasks.length;
                    // Add remaining rows tasks
                    const remainingRows = this.rowOrder.length - this.currentRowIndex -1;
                    if(remainingRows > 0) {
                        remaining += remainingRows * 10;
                    }
                }
                this.ui.taskCounter.textContent = `Übrig: ${remaining}`;
            },

            startTimer() {
                this.timerInterval = setInterval(() => {
                    if (!this.startTime) return;
                    const elapsed = Math.floor((new Date() - this.startTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    this.ui.timer.textContent = `Zeit: ${minutes}:${String(seconds).padStart(2, '0')}`;
                }, 1000);
            },

            // --- UTILITY ---
            shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
        };

        // Initialize the application
        app.init();
    </script>

<script>
    function updateAppHeight() {
        const appHeight = window.innerHeight;
        document.documentElement.style.setProperty('--app-height', `${appHeight}px`);
    }
    window.addEventListener('resize', updateAppHeight);
    window.addEventListener('orientationchange', updateAppHeight);
    updateAppHeight(); // Initial call
</script>

</body>
</html>

